deploy:
  needs: build_and_push
  runs-on: ubuntu-latest
  env:
    IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/next-ec2-app
  steps:
    - name: Prepare SSH key
      run: |
        echo "${{ secrets.EC2_KEY_B64 }}" | base64 -d > key.pem
        chmod 600 key.pem
        ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "echo ok" || exit 1

    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key_path: key.pem
        script: |
          set -e
          docker pull ${{ env.IMAGE_NAME }}:latest
          docker ps -aq --filter "name=next-ec2" | xargs -r docker rm -f
          docker run -d --name next-ec2 --restart unless-stopped -p 80:3000 \
            -e NODE_ENV=production ${{ env.IMAGE_NAME }}:latest
